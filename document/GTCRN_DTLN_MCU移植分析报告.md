# GTCRN与DTLN算法MCU移植分析报告

## 1. 算法计算资源对比

### 1.1 GTCRN_Stream

| 指标 | 数值 | 说明 |
|------|------|------|
| **参数量** | 48.2K | 包含ERB模块的不可学习参数 |
| **模型权重内存** | ~193 KB (FP32) / ~96 KB (FP16) | 48.2K × 4 bytes |
| **Cache内存** | ~17 KB (FP32) | conv_cache + tra_cache + inter_cache |
| **MMACs/s** | 33.0 MMACs/s | 每秒3300万次乘加运算 |
| **每帧MMACs** | 0.528 MMACs | 33.0 / 62.5帧 (16ms帧移) |
| **所需核心频率** | ~10-15 MHz (理论) / ~50-80 MHz (实际) | 考虑内存访问、非MAC操作等开销 |

**Cache张量详细规格（batch_size=1）：**
- `conv_cache`: (2, 1, 16, 16, 33) = 16,896 floats ≈ 67.6 KB
- `tra_cache`: (2, 3, 1, 1, 16) = 96 floats ≈ 0.4 KB
- `inter_cache`: (2, 1, 33, 16) = 1,056 floats ≈ 4.2 KB

**总运行时内存需求：** ~193 KB (权重) + ~72 KB (cache) + ~50 KB (中间变量) ≈ **315 KB**

### 1.2 DTLN (Dual-signal Transformation LSTM Network)

| 指标 | 数值 | 说明 |
|------|------|------|
| **参数量** | ~2.0M (约2百万) | 两个LSTM模块，每个128单元 |
| **模型权重内存** | ~8 MB (FP32) / ~4 MB (FP16) | 2M × 4 bytes |
| **LSTM隐状态内存** | ~4 KB | 4个LSTM层 × 128单元 × 2(h,c) × 4 bytes |
| **MMACs/s** | ~300-400 MMACs/s | LSTM计算密集 |
| **每帧MMACs** | ~5-6 MMACs | 基于32ms帧长、8ms帧移 |
| **所需核心频率** | ~200-400 MHz (实际) | LSTM顺序依赖性高，难以并行 |

**总运行时内存需求：** ~8 MB (权重) + ~4 KB (隐状态) + ~1-2 MB (中间变量) ≈ **9-10 MB**

### 1.3 对比总结

| 指标 | GTCRN_Stream | DTLN | 比值 (GTCRN:DTLN) |
|------|--------------|------|-------------------|
| 参数量 | 48.2K | ~2M | **1:41** |
| 模型内存 | ~193KB | ~8MB | **1:41** |
| 运行内存 | ~315KB | ~10MB | **1:32** |
| MMACs/s | 33 | ~350 | **1:10** |
| 所需频率 | ~50-80MHz | ~200-400MHz | **1:4~5** |

**结论：** GTCRN在所有资源指标上都显著优于DTLN，特别适合资源受限的嵌入式平台。

---

## 2. NXP RT1052 平台移植可行性分析

### 2.1 RT1052 平台规格

| 规格 | 数值 |
|------|------|
| 内核 | ARM Cortex-M7 |
| 主频 | 528 MHz (最高600MHz) |
| 内部SRAM | 512 KB |
| 外部存储支持 | SDRAM/HyperRAM/QSPI Flash |
| FPU | 双精度浮点单元 |
| DSP指令 | 支持SIMD (单周期MAC) |
| 理论峰值 | ~500 MMAC/s (单精度) |

### 2.2 GTCRN_Stream 移植可行性：✅ 完全可行

| 评估项 | 需求 | RT1052能力 | 结论 |
|--------|------|------------|------|
| 计算能力 | ~33 MMACs/s | ~500 MMACs/s | ✅ 余量充足 (仅用6.6%) |
| 模型存储 | ~193 KB | 512 KB SRAM | ✅ 可放入内部SRAM |
| 运行内存 | ~315 KB | 512 KB SRAM | ✅ 充足 |
| 实时性 | 16ms帧周期 | 预计3-5ms处理时间 | ✅ RTF < 0.3 |

**优势：**
- 模型小，可完全放入内部SRAM，避免外部存储访问延迟
- 计算量低，有大量余量用于其他任务（如VAD、AEC等）
- 使用CMSIS-NN/DSP库可进一步优化
- Cortex-M7的FPU和DSP指令可高效执行矩阵运算

**实现挑战：**
- 需要手写GRU实现（无现成深度学习框架）
- ERB滤波器矩阵运算需使用CMSIS-DSP优化
- BatchNorm需转换为推理模式的scale/bias形式
- 需要实现流式STFT/ISTFT

**预计开发工作量：** 2-4周（有经验的嵌入式工程师）

### 2.3 DTLN 移植可行性：❌ 困难，不推荐

| 评估项 | 需求 | RT1052能力 | 结论 |
|--------|------|------------|------|
| 计算能力 | ~350 MMACs/s | ~500 MMACs/s | ⚠️ 占用70%，余量小 |
| 模型存储 | ~8 MB | 512 KB SRAM | ❌ 必须用外部存储 |
| 运行内存 | ~10 MB | 512 KB SRAM | ❌ 严重不足 |
| 实时性 | 8ms帧周期 | 预计10-15ms处理时间 | ❌ 无法实时 |

**主要障碍：**

1. **内存瓶颈（致命）**
   - 8MB模型无法放入512KB内部SRAM
   - 必须使用外部SDRAM，访问延迟增加5-10倍
   - 频繁的外部存储访问会严重拖慢推理速度

2. **计算瓶颈**
   - LSTM的顺序依赖性导致难以利用SIMD并行
   - 每个时间步必须等待前一步完成
   - 实际效率远低于理论峰值

3. **实时性风险**
   - 即使勉强运行，RTF可能>1
   - 8ms的帧移要求更严格的实时性
   - 无法满足实时语音增强需求

**结论：** 不建议在RT1052上移植DTLN，除非接受以下妥协：
- 使用INT8量化（精度损失）
- 降低采样率或增大帧移（延迟增加）
- 使用更大内存的外部芯片方案

---

## 3. GTCRN_Stream 推荐MCU平台

### 3.1 推荐平台列表

| 优先级 | 平台 | 主频 | 内存 | 特点 | 参考价格 |
|--------|------|------|------|------|----------|
| ⭐⭐⭐ | **NXP RT1060/1064** | 600MHz | 1MB SRAM | Cortex-M7, 性价比高 | $5-8 |
| ⭐⭐⭐ | **STM32H7系列** | 480MHz | 1MB SRAM | Cortex-M7, 生态完善 | $6-10 |
| ⭐⭐⭐ | **ESP32-S3** | 240MHz | 512KB+8MB PSRAM | 双核, WiFi/BLE | $2-4 |
| ⭐⭐ | **NXP RT1050/1052** | 528MHz | 512KB SRAM | Cortex-M7 | $4-6 |
| ⭐⭐ | **Kendryte K210** | 400MHz | 8MB SRAM | RISC-V, 内置KPU | $3-5 |
| ⭐ | **RP2040** | 133MHz | 264KB SRAM | 双核M0+, 极低成本 | $0.7-1 |

### 3.2 详细推荐分析

#### 首选：NXP i.MX RT1060/1064

**推荐理由：**
- 与RT1052同系列，开发迁移成本低
- 1MB SRAM提供更大余量，可同时运行多个算法
- 600MHz主频，计算余量充足
- 完善的音频外设（I2S、SAI）

**预计性能：**
- RTF < 0.2
- 可同时运行VAD、AEC等其他音频处理任务
- 支持双麦克风阵列处理

**适用场景：** 智能音箱、会议系统、车载语音

#### 性价比之选：ESP32-S3

**推荐理由：**
- 成本极低（$2-4）
- 双核240MHz，一核专用于音频处理
- 内置WiFi/BLE，适合IoT场景
- 8MB PSRAM可存储更大模型

**预计性能：**
- RTF约0.3-0.5
- 需要使用ESP-DSP库优化矩阵运算
- 建议使用FP16或INT8量化

**适用场景：** 智能家居、IoT语音设备、低成本消费电子

#### 工业级选择：STM32H7

**推荐理由：**
- ST生态完善，开发资源丰富
- CMSIS-NN支持好，优化工具链成熟
- 480MHz + 1MB SRAM
- 工业级温度范围和可靠性

**推荐型号：** STM32H743/H750/H753

**预计性能：**
- RTF < 0.25
- 可使用STM32Cube.AI工具链

**适用场景：** 工业设备、医疗器械、专业音频设备

#### 极致成本：RP2040

**推荐理由：**
- 成本<$1，适合大批量产品
- 双核可并行处理

**挑战：**
- 133MHz较低，必须使用INT8量化
- 264KB SRAM较紧张
- 需要深度优化代码

**适用场景：** 对成本极度敏感的大批量消费产品

### 3.3 选型决策树

```
                    ┌─ 性能优先 ─→ RT1060/1064 或 STM32H7
                    │
需要移植GTCRN ──────┼─ 成本优先 ─┬─ 需要WiFi ─→ ESP32-S3
                    │            └─ 不需要WiFi ─→ RT1052
                    │
                    └─ 极致成本 ─→ RP2040 (需INT8量化)
```

### 3.4 移植建议

1. **优先使用FP32**：GTCRN本身计算量很小，大多数平台无需量化
2. **利用CMSIS-DSP**：矩阵乘法、卷积等操作使用优化库
3. **预计算ERB滤波器**：将ERB矩阵存储为常量，避免运行时计算
4. **BatchNorm融合**：将BN层融合到卷积层，减少计算量
5. **内存对齐**：确保张量内存对齐以利用SIMD指令

---

## 附录：关键数据来源

- GTCRN参数量和MMACs：基于代码仓库 `gtcrn.py` 中的ptflops测量
- DTLN参数量：基于原论文和GitHub仓库 (github.com/breizhn/DTLN)
- RT1052规格：NXP官方数据手册
- 频率估算：基于Cortex-M7单周期MAC和典型内存访问开销

---

*文档生成日期：2024年*
*基于GTCRN代码仓库分析*
