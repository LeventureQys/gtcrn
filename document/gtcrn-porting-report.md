# GTCRN æµå¼æ¨¡å‹çº¯ C ç§»æ¤æŠ€æœ¯åˆ†ææŠ¥å‘Š

## 1. æ¨¡å‹æ¦‚è§ˆ

GTCRNï¼ˆGroup Temporal Convolutional Recurrent Networkï¼‰æ˜¯ä¸€ä¸ªè¶…è½»é‡çº§è¯­éŸ³å¢å¼ºæ¨¡å‹ï¼š
- **è®¡ç®—é‡**ï¼š33.0 MMACs
- **å‚æ•°é‡**ï¼š23.67K
- **ç”¨é€”**ï¼šå®æ—¶è¯­éŸ³é™å™ª/å¢å¼º

### 1.1 æ•´ä½“æ•°æ®æµ

```
è¾“å…¥éŸ³é¢‘ â†’ STFT â†’ ERBå­å¸¦åˆ†æ â†’ SFEç‰¹å¾æå– â†’ Encoder â†’ DPGRNNÃ—2 â†’ Decoder â†’ æ©ç  â†’ iSTFT â†’ è¾“å‡ºéŸ³é¢‘
```

---

## 2. éœ€è¦ç§»æ¤çš„ç½‘ç»œæ¨¡å—æ¸…å•

### 2.1 æ¨¡å—ä¾èµ–å…³ç³»å›¾

```
StreamGTCRN (ä¸»æ¨¡å‹)
â”œâ”€â”€ ERB (ERBæ»¤æ³¢å™¨ç»„)
â”‚   â”œâ”€â”€ erb_fc (Linear, æ— åç½®)
â”‚   â””â”€â”€ ierb_fc (Linear, æ— åç½®)
â”œâ”€â”€ SFE (å­å¸¦ç‰¹å¾æå–)
â”‚   â””â”€â”€ Unfold æ“ä½œ
â”œâ”€â”€ StreamEncoder
â”‚   â”œâ”€â”€ ConvBlock Ã— 2
â”‚   â”‚   â”œâ”€â”€ Conv2d / ConvTranspose2d
â”‚   â”‚   â”œâ”€â”€ BatchNorm2d
â”‚   â”‚   â””â”€â”€ PReLU / Tanh
â”‚   â””â”€â”€ StreamGTConvBlock Ã— 3
â”‚       â”œâ”€â”€ SFE
â”‚       â”œâ”€â”€ Conv2d (pointwise)
â”‚       â”œâ”€â”€ StreamConv2d (depthwise, å¸¦ç¼“å­˜)
â”‚       â”œâ”€â”€ BatchNorm2d
â”‚       â”œâ”€â”€ PReLU
â”‚       â””â”€â”€ StreamTRA (æ—¶åºæ³¨æ„åŠ›)
â”‚           â”œâ”€â”€ GRU
â”‚           â”œâ”€â”€ Linear
â”‚           â””â”€â”€ Sigmoid
â”œâ”€â”€ DPGRNN Ã— 2 (åŒè·¯å¾„åˆ†ç»„RNN)
â”‚   â”œâ”€â”€ GRNN (intra, åŒå‘)
â”‚   â”œâ”€â”€ GRNN (inter, å•å‘)
â”‚   â”œâ”€â”€ Linear Ã— 2
â”‚   â””â”€â”€ LayerNorm Ã— 2
â”œâ”€â”€ StreamDecoder (ç»“æ„å¯¹ç§°äºEncoder)
â””â”€â”€ Mask (å¤æ•°æ©ç è¿ç®—)
```

---

## 3. å„æ¨¡å—ç§»æ¤è¯¦è§£

### 3.1 åŸºç¡€ç®—å­å±‚ï¼ˆå¿…é¡»é¦–å…ˆå®ç°ï¼‰

| ç®—å­ | å¤æ‚åº¦ | è¯´æ˜ |
|------|--------|------|
| **çŸ©é˜µä¹˜æ³• (MatMul)** | â˜…â˜…â˜† | Linear å±‚æ ¸å¿ƒï¼Œéœ€ä¼˜åŒ– |
| **Conv2d** | â˜…â˜…â˜… | æ”¯æŒ groupsã€dilationã€ä¸åŒ stride |
| **ConvTranspose2d** | â˜…â˜…â˜… | è½¬ç½®å·ç§¯ï¼Œæ³¨æ„ output padding |
| **BatchNorm2d** | â˜…â˜†â˜† | æ¨ç†æ—¶å¯èåˆè¿›å·ç§¯ |
| **LayerNorm** | â˜…â˜…â˜† | éœ€è¦åœ¨çº¿è®¡ç®—å‡å€¼/æ–¹å·® |
| **GRU** | â˜…â˜…â˜… | å¾ªç¯å•å…ƒï¼Œéœ€ç»´æŠ¤éšçŠ¶æ€ |
| **PReLU** | â˜…â˜†â˜† | å¸¦å­¦ä¹ å‚æ•°çš„æ¿€æ´»å‡½æ•° |
| **Sigmoid/Tanh** | â˜…â˜†â˜† | å¯ç”¨æŸ¥è¡¨æˆ–è¿‘ä¼¼å…¬å¼ |

### 3.2 ç‰¹æ®Šæ“ä½œå±‚

| æ“ä½œ | è¯´æ˜ | ç§»æ¤éš¾ç‚¹ |
|------|------|----------|
| **Unfold** | æ»‘åŠ¨çª—å£æå– | éœ€ç†è§£å†…å­˜å¸ƒå±€ |
| **Channel Shuffle** | é€šé“é‡æ’ | çº¯å†…å­˜æ“ä½œ |
| **StreamConv2d** | å¸¦æ—¶åºç¼“å­˜çš„å·ç§¯ | éœ€è¦ç»´æŠ¤å¸§é—´ç¼“å­˜ |
| **Tensor Reshape/Permute** | ç»´åº¦å˜æ¢ | æ ¸å¿ƒéš¾ç‚¹ä¹‹ä¸€ |

---

## 4. ä¸»è¦ç§»æ¤æŒ‘æˆ˜

### 4.1 ğŸ”´ é«˜éš¾åº¦æŒ‘æˆ˜

#### (1) å¤šç»´å¼ é‡å†…å­˜ç®¡ç†
```c
// PyTorch: spec.permute(0,3,2,1) ä¸€è¡Œä»£ç 
// Cè¯­è¨€: éœ€è¦æ˜¾å¼å¤„ç†å†…å­˜å¸ƒå±€æˆ–æ‹·è´

// å»ºè®®æ–¹æ¡ˆï¼šå®šä¹‰ç»Ÿä¸€çš„ Tensor ç»“æ„
typedef struct {
    float *data;
    int dims[4];      // å„ç»´åº¦å¤§å°
    int strides[4];   // å„ç»´åº¦æ­¥é•¿
} Tensor4D;
```

**æŒ‘æˆ˜ç‚¹**ï¼š
- æ¨¡å‹ä¸­é¢‘ç¹ä½¿ç”¨ `permute`, `reshape`, `transpose`
- éœ€è¦å†³å®šï¼šæ˜¯å®é™…æ‹·è´æ•°æ®ï¼Œè¿˜æ˜¯åªæ”¹å˜ strideï¼ˆè§†å›¾ï¼‰
- é”™è¯¯çš„å†…å­˜å¸ƒå±€ä¼šå¯¼è‡´è®¡ç®—ç»“æœå®Œå…¨é”™è¯¯

#### (2) GRU å¾ªç¯å•å…ƒå®ç°
```python
# PyTorch ä¸€è¡Œä»£ç 
output, h_new = gru(input, h_old)
```

éœ€è¦æ‰‹åŠ¨å®ç°çš„è®¡ç®—ï¼š
```
r_t = sigmoid(W_ir @ x_t + b_ir + W_hr @ h_{t-1} + b_hr)  # é‡ç½®é—¨
z_t = sigmoid(W_iz @ x_t + b_iz + W_hz @ h_{t-1} + b_hz)  # æ›´æ–°é—¨
n_t = tanh(W_in @ x_t + b_in + r_t * (W_hn @ h_{t-1} + b_hn))  # å€™é€‰çŠ¶æ€
h_t = (1 - z_t) * n_t + z_t * h_{t-1}  # æ–°çŠ¶æ€
```

**æŒ‘æˆ˜ç‚¹**ï¼š
- éœ€è¦æ­£ç¡®è§£æ PyTorch GRU çš„æƒé‡æ ¼å¼ï¼ˆW_ih, W_hh, b_ih, b_hh çš„æ‹¼æ¥é¡ºåºï¼‰
- åŒå‘ GRU éœ€è¦å‰å‘+åå‘ä¸¤æ¬¡è®¡ç®—
- åˆ†ç»„ GRU (GRNN) éœ€è¦æ‹†åˆ†è¾“å…¥å’ŒéšçŠ¶æ€

#### (3) æµå¼ç¼“å­˜çŠ¶æ€ç®¡ç†
```python
# æ¨¡å‹éœ€è¦ç»´æŠ¤ä¸‰ç±»ç¼“å­˜
conv_cache: (2, 1, 16, 16, 33)   # å› æœå·ç§¯çš„å†å²å¸§ç¼“å­˜
tra_cache:  (2, 3, 1, 1, 16)     # TRAæ¨¡å—çš„GRUéšçŠ¶æ€
inter_cache:(2, 1, 33, 16)       # DPGRNNçš„inter-GRUéšçŠ¶æ€
```

**æŒ‘æˆ˜ç‚¹**ï¼š
- å¿…é¡»ç²¾ç¡®ç»´æŠ¤ç¼“å­˜çš„æ»‘åŠ¨æ›´æ–°
- ç¼“å­˜å¤§å°ä¸ dilation rate ç›¸å…³ï¼ˆ1, 2, 5 å¯¹åº”ä¸åŒç¼“å­˜é•¿åº¦ï¼‰
- ç¼–ç å™¨å’Œè§£ç å™¨å„æœ‰ç‹¬ç«‹ç¼“å­˜

### 4.2 ğŸŸ¡ ä¸­ç­‰éš¾åº¦æŒ‘æˆ˜

#### (4) å¸¦ Dilation çš„åˆ†ç»„æ·±åº¦å·ç§¯
```python
StreamConv2d(hidden_channels, hidden_channels, (3,3),
             stride=(1,1), padding=(0,1), 
             dilation=(5,1),  # æ—¶é—´è½´è†¨èƒ€ç‡=5
             groups=hidden_channels)  # æ·±åº¦å¯åˆ†ç¦»
```

**æŒ‘æˆ˜ç‚¹**ï¼š
- `dilation` å¯¼è‡´æ„Ÿå—é‡æ‰©å¤§ï¼Œéœ€è¦æ›´å¤§çš„ç¼“å­˜
- `groups=hidden_channels` æ„å‘³ç€æ¯ä¸ªé€šé“ç‹¬ç«‹å·ç§¯
- æµå¼æ¨ç†éœ€è¦ç»´æŠ¤ `(kernel_size-1)*dilation` å¸§çš„å†å²

#### (5) ERB æ»¤æ³¢å™¨ç»„
```python
# å°†257ä¸ªé¢‘ç‚¹æ˜ å°„åˆ°129ä¸ªERBå­å¸¦
x_low = x[..., :65]              # ä½é¢‘ä¿ç•™
x_high = erb_fc(x[..., 65:])     # é«˜é¢‘ERBå‹ç¼©ï¼š192â†’64
```

**æŒ‘æˆ˜ç‚¹**ï¼š
- æ»¤æ³¢å™¨æƒé‡æ˜¯é¢„è®¡ç®—çš„ä¸‰è§’æ»¤æ³¢å™¨ç»„
- éœ€è¦å¤„ç†é€†å˜æ¢ (bsæ–¹æ³•)
- æƒé‡å›ºå®šï¼Œå¯ç¡¬ç¼–ç æˆ–ä»æ–‡ä»¶åŠ è½½

#### (6) BatchNorm æ¨ç†ä¼˜åŒ–
```python
# è®­ç»ƒæ—¶ï¼šy = (x - mean) / sqrt(var + eps) * gamma + beta
# æ¨ç†æ—¶ï¼šå¯ä»¥é¢„å…ˆèåˆå‚æ•°
# y = x * scale + bias
# å…¶ä¸­ scale = gamma / sqrt(running_var + eps)
#      bias = beta - running_mean * scale
```

**å»ºè®®**ï¼šå°† BN å‚æ•°èåˆè¿›å‰ä¸€å±‚å·ç§¯ï¼Œå‡å°‘è®¡ç®—é‡

### 4.3 ğŸŸ¢ ç›¸å¯¹ç®€å•

#### (7) æ¿€æ´»å‡½æ•°
```c
// Sigmoid: å¯ç”¨å¿«é€Ÿè¿‘ä¼¼
float fast_sigmoid(float x) {
    return 0.5f * (x / (1.0f + fabsf(x)) + 1.0f);
}

// Tanh: åˆ©ç”¨ sigmoid å…³ç³»
float fast_tanh(float x) {
    return 2.0f * fast_sigmoid(2.0f * x) - 1.0f;
}

// PReLU: y = max(0,x) + alpha * min(0,x)
float prelu(float x, float alpha) {
    return x > 0 ? x : alpha * x;
}
```

#### (8) Mask å¤æ•°è¿ç®—
```c
// å¤æ•°ä¹˜æ³•ï¼š(a+bi)(c+di) = (ac-bd) + (ad+bc)i
void complex_mask(float *spec_r, float *spec_i, 
                  float *mask_r, float *mask_i,
                  float *out_r, float *out_i, int n) {
    for (int i = 0; i < n; i++) {
        out_r[i] = spec_r[i]*mask_r[i] - spec_i[i]*mask_i[i];
        out_i[i] = spec_i[i]*mask_r[i] + spec_r[i]*mask_i[i];
    }
}
```

---

## 5. æƒé‡æ–‡ä»¶è§£æ

### 5.1 éœ€è¦å¯¼å‡ºçš„æƒé‡

| æ¨¡å— | æƒé‡åç§° | å½¢çŠ¶ | è¯´æ˜ |
|------|----------|------|------|
| ERB | erb_fc.weight | (64, 192) | ERBæ»¤æ³¢å™¨ï¼Œå›ºå®šä¸è®­ç»ƒ |
| ERB | ierb_fc.weight | (192, 64) | é€†ERBæ»¤æ³¢å™¨ |
| ConvBlock | conv.weight | å˜åŒ– | å·ç§¯æ ¸ |
| ConvBlock | bn.* | 4ä¸ªå‚æ•° | gamma, beta, mean, var |
| ConvBlock | act.weight | (C,) | PReLUæ–œç‡ |
| GRU | weight_ih_l0 | (3H, I) | è¾“å…¥-éšå±‚æƒé‡ |
| GRU | weight_hh_l0 | (3H, H) | éšå±‚-éšå±‚æƒé‡ |
| GRU | bias_ih_l0 | (3H,) | è¾“å…¥åç½® |
| GRU | bias_hh_l0 | (3H,) | éšå±‚åç½® |
| LayerNorm | weight, bias | (F, C) | å½’ä¸€åŒ–å‚æ•° |
| Linear | weight, bias | å˜åŒ– | å…¨è¿æ¥å‚æ•° |

### 5.2 å»ºè®®çš„æƒé‡å¯¼å‡ºæ ¼å¼
```python
# å¯¼å‡ºä¸ºç®€å•çš„äºŒè¿›åˆ¶æ ¼å¼
import struct
def export_weights(model, filename):
    with open(filename, 'wb') as f:
        for name, param in model.named_parameters():
            data = param.detach().cpu().numpy().flatten()
            # å†™å…¥: åç§°é•¿åº¦ + åç§° + ç»´åº¦æ•° + å„ç»´åº¦ + æ•°æ®
            f.write(struct.pack('I', len(name)))
            f.write(name.encode())
            f.write(struct.pack('I', len(param.shape)))
            for d in param.shape:
                f.write(struct.pack('I', d))
            f.write(struct.pack(f'{len(data)}f', *data))
```

---

## 6. æ¨èç§»æ¤é¡ºåº

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½
1. âœ… å®šä¹‰ Tensor ç»“æ„å’Œå†…å­˜ç®¡ç†
2. âœ… å®ç°åŸºç¡€æ•°å­¦å‡½æ•°ï¼ˆçŸ©é˜µä¹˜ã€å‘é‡è¿ç®—ï¼‰
3. âœ… å®ç°æ¿€æ´»å‡½æ•°ï¼ˆSigmoid, Tanh, PReLUï¼‰
4. âœ… æƒé‡åŠ è½½å™¨

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒç®—å­
5. âœ… Conv2dï¼ˆæ”¯æŒ groups, dilation, paddingï¼‰
6. âœ… ConvTranspose2d
7. âœ… BatchNorm2dï¼ˆå»ºè®®èåˆï¼‰
8. âœ… Linear
9. âœ… LayerNorm

### ç¬¬ä¸‰é˜¶æ®µï¼šå¾ªç¯å•å…ƒ
10. âœ… GRU å•å…ƒ
11. âœ… åŒå‘ GRU
12. âœ… GRNNï¼ˆåˆ†ç»„ GRUï¼‰

### ç¬¬å››é˜¶æ®µï¼šç»„åˆæ¨¡å—
13. âœ… ERB æ»¤æ³¢å™¨ç»„
14. âœ… SFE (Unfold)
15. âœ… StreamTRA
16. âœ… StreamGTConvBlockï¼ˆå«ç¼“å­˜ï¼‰
17. âœ… DPGRNN

### ç¬¬äº”é˜¶æ®µï¼šå®Œæ•´æ¨¡å‹
18. âœ… StreamEncoder
19. âœ… StreamDecoder
20. âœ… StreamGTCRN ä¸»æµç¨‹
21. âœ… éªŒè¯ä¸ä¼˜åŒ–

---

## 7. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 7.1 å†…å­˜ä¼˜åŒ–
- é¢„åˆ†é…æ‰€æœ‰ä¸­é—´å¼ é‡ï¼Œé¿å…è¿è¡Œæ—¶ malloc
- ä½¿ç”¨ buffer å¤ç”¨ï¼Œencoder å’Œ decoder å¯å…±äº«ä¸´æ—¶ç©ºé—´
- å¯¹äºåµŒå…¥å¼å¹³å°ï¼Œè€ƒè™‘ä½¿ç”¨ int8 é‡åŒ–

### 7.2 è®¡ç®—ä¼˜åŒ–
- BatchNorm èåˆè¿›å·ç§¯
- ä½¿ç”¨ SIMD æŒ‡ä»¤ï¼ˆARM NEON / x86 SSEï¼‰
- åˆ†ç»„å·ç§¯å¤©ç„¶é€‚åˆå¹¶è¡ŒåŒ–
- GRU çš„é—¨è®¡ç®—å¯ä»¥åˆå¹¶çŸ©é˜µä¹˜

### 7.3 å‚è€ƒå®ç°
- å¯å‚è€ƒ ONNX Runtime çš„ç®—å­å®ç°
- å¯å‚è€ƒ CMSIS-NNï¼ˆARM Cortex-M ä¼˜åŒ–åº“ï¼‰
- å¯å‚è€ƒ XNNPACKï¼ˆGoogle çš„åµŒå…¥å¼ç¥ç»ç½‘ç»œåº“ï¼‰

---

## 8. éªŒè¯ç­–ç•¥

### 8.1 åˆ†å±‚éªŒè¯
```python
# æ¯ç§»æ¤ä¸€ä¸ªæ¨¡å—ï¼Œä¸ PyTorch è¾“å‡ºå¯¹æ¯”
def verify_module(c_output, py_output, name, tol=1e-5):
    diff = np.abs(c_output - py_output).max()
    print(f"{name}: max_diff = {diff:.2e}, {'PASS' if diff < tol else 'FAIL'}")
```

### 8.2 å»ºè®®çš„æµ‹è¯•é¡ºåº
1. å•ä¸ª Conv2d â†’ å¯¹æ¯” PyTorch
2. ConvBlock (Conv+BN+Act) â†’ å¯¹æ¯”
3. GRU å•æ­¥ â†’ å¯¹æ¯”
4. å®Œæ•´ DPGRNN â†’ å¯¹æ¯”
5. å•å¸§æ¨ç† â†’ å¯¹æ¯”
6. å¤šå¸§æµå¼æ¨ç† â†’ ä¸ ONNX è¾“å‡ºå¯¹æ¯”

### 8.3 æœ€ç»ˆéªŒè¯æŒ‡æ ‡
- ä¸ PyTorch è¾“å‡ºçš„æœ€å¤§ç»å¯¹è¯¯å·® < 1e-4ï¼ˆfloat32ï¼‰
- ä¸ ONNX Runtime è¾“å‡ºå¯¹é½
- å®æ—¶å› å­ (RTF) < 1.0ï¼ˆæ»¡è¶³å®æ—¶æ€§ï¼‰

---

## 9. æ€»ç»“

| ç±»åˆ« | æ•°é‡ | éš¾åº¦è¯„ä¼° |
|------|------|----------|
| åŸºç¡€ç®—å­ | 8 ç§ | â˜…â˜…â˜† |
| ç‰¹æ®Šæ“ä½œ | 4 ç§ | â˜…â˜…â˜… |
| ç»„åˆæ¨¡å— | 6 ç§ | â˜…â˜…â˜† |
| æµå¼ç¼“å­˜ç®¡ç† | 3 ç±» | â˜…â˜…â˜… |

**é¢„ä¼°å·¥ä½œé‡**ï¼š
- æœ‰åµŒå…¥å¼ NN ç»éªŒï¼š2-4 å‘¨
- æ— ç›¸å…³ç»éªŒï¼š4-8 å‘¨

**æœ€å¤§é£é™©ç‚¹**ï¼š
1. GRU æƒé‡æ ¼å¼è§£æé”™è¯¯
2. æµå¼ç¼“å­˜æ›´æ–°é€»è¾‘é”™è¯¯
3. å¼ é‡ç»´åº¦å˜æ¢é”™è¯¯

å»ºè®®å…ˆç”¨ ONNX Runtime éªŒè¯æµå¼é€»è¾‘æ­£ç¡®æ€§ï¼Œå†é€æ­¥ç§»æ¤åˆ°çº¯ Cã€‚
